<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>TinyIMG Editor</title>
    <link
      rel="icon"
      sizes="16x16"
      type="image/png"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABX0lEQVR4AZySv0vDQBTH3x1qjaUGpeAg+A/oX+DiLeKsS7v6P+jaxl+Tf4RDHSpUuujkkFhBXOIgaqEq6mJBqxIzxFDlvHdyMbE/CAl8717uve/nvQuhkPBp5/MMlQjQri8ZhH2bojdLBCDAizD3BYPlskHvXc7uHG7ElfuwjZ3B02YtMQFQzsEkBIpxpXmnzE/NwMv4ChPNzeAKE60C6O4eQntK5T9T00GNBAz7V5DyL0H/6A/YqR6BM5oDJ5OLApCIiefshkw0vWs4f6/IOLygERU+kxPgASYQhOaDp3Ww3yodkOXFeSyNKADgqTJjjOoGqd3swubhAjy+XmAJRAB2l7HDEDTXGiVpLJ2tQr158gfAsXECmf23IKR6WwBlVul9e+sXgB+sl1kVt0gDhkYG1GuwUzRjh+CkTzA2lemA0LhmxU1nNRXKnRIgayLC/zqWxDUsfTJtCZ/FgR//AAAA//8AWlArAAAABklEQVQDACmTvcxXtNMdAAAAAElFTkSuQmCC"
    >
    <meta name="theme-color" content="#000">
    <meta name="keywords" content="image, editor, tiny">
    <meta name="description" content="Tiny IMG Editor.">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0"
    >
    <style>
      *{font-family:Arial;font-size:16px;box-sizing:border-box;user-select:none;-moz-user-select:none;-webkit-user-select:none}body{margin:0;background:#000;display:flex;height:100vh;overflow:hidden}.toolbar{position:fixed;top:0;left:0;width:165px;height:100%;background:#efefef;border-right:1px solid #5a5a5a;padding:5px;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;align-items:stretch;text-align:left;display:none}.toolbar::-webkit-scrollbar{display:none}.toolbar strong{margin-top:10px;margin-bottom:5px}.toolbar hr{border:0;height:1px;background:#c4c4c4;margin:10px 0}.toolbar input[type=file],.toolbar button{margin:5px 5px;padding-left:5px;padding-top:5px;padding-right:5px;padding-bottom:2px}button,label{cursor:pointer}button{border:0;background-color:#efefef}button:hover{background-color:#d6d6d6}label{display:inline-flex;align-items:center;gap:5px;margin-top:5px;margin-left:10px;margin-right:10px;margin-bottom:5px}.toolbar input[type=checkbox]{margin-right:6px;cursor:pointer}.toolbar input[type=checkbox]:disabled{cursor:default}.toolbar button.selected{outline:2px solid #3a76b1;background-color:#dce9f9}.containerResize{display:flex;justify-content:center;flex-direction:column;gap:8px}.title{display:flex;justify-content:center;cursor:default;margin-top:15px;margin-bottom:10px;-webkit-user-select:none;-moz-user-select:none;user-select:none}.workspace{flex:1;display:flex;justify-content:center;align-items:center;margin-left:165px;overflow:auto}canvas{background:#fff;max-width:100%;max-height:100%;display:none}input[type=file]{display:none}input[type=number]{width:100%;padding:6px;border:1px solid #c4c4c4;border-radius:4px;background-color:#fff}input[type=number]{background-color:#fff;border:1px solid #c4c4c4;border-radius:4px}input[type=number]:disabled{background-color:#efefef;opacity:.4}.disabled{opacity:.2;cursor:default!important}.disabled:hover{background-color:transparent!important}.color-picker{display:flex;justify-content:center;flex-direction:column;gap:8px}.color-picker-preview{width:100%;height:32px;border:1px solid #c4c4c4;border-radius:4px;background:red}.color-picker-input{width:100%;padding:6px;border:1px solid #c4c4c4;border-radius:4px;background-color:#fff}.color-picker-input:disabled{background-color:#efefef}.color-picker.disabled{opacity:.4;pointer-events:none}@media (pointer:coarse){button:hover{border:0;background-color:#efefef}}.pleasewait{position:fixed;width:64px;height:64px;left:0;right:0;top:0;bottom:0;margin:auto;border:0;z-index:9}.lds-spinner{color:#fff;display:inline-block;position:relative;width:64px;height:64px}.lds-spinner div{transform-origin:32px 32px;animation:lds-spinner 1.2s linear infinite}.lds-spinner div:after{content:" ";display:block;position:absolute;top:3px;left:29px;width:5px;height:14px;border-radius:20%;background:#fff}.lds-spinner div:nth-child(1){transform:rotate(0deg);animation-delay:-1.1s}.lds-spinner div:nth-child(2){transform:rotate(30deg);animation-delay:-1s}.lds-spinner div:nth-child(3){transform:rotate(60deg);animation-delay:-.9s}.lds-spinner div:nth-child(4){transform:rotate(90deg);animation-delay:-.8s}.lds-spinner div:nth-child(5){transform:rotate(120deg);animation-delay:-.7s}.lds-spinner div:nth-child(6){transform:rotate(150deg);animation-delay:-.6s}.lds-spinner div:nth-child(7){transform:rotate(180deg);animation-delay:-.5s}.lds-spinner div:nth-child(8){transform:rotate(210deg);animation-delay:-.4s}.lds-spinner div:nth-child(9){transform:rotate(240deg);animation-delay:-.3s}.lds-spinner div:nth-child(10){transform:rotate(270deg);animation-delay:-.2s}.lds-spinner div:nth-child(11){transform:rotate(300deg);animation-delay:-.1s}.lds-spinner div:nth-child(12){transform:rotate(330deg);animation-delay:0s}@keyframes lds-spinner{0%{opacity:1}to{opacity:0}}
    </style>
  </head>
  <body>
    <div class="pleasewait">
      <div class="lds-spinner">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>
    <div class="toolbar">
      <input type="file" id="fileSelector" accept="image/*,.svg,.svg+xml">
      <button id="btnOpen">
        <svg
          width="28"
          height="28"
          viewBox="0 0 576 512"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M147.8 192H480V144C480 117.5 458.5 96 432 96h-160l-64-64h-160C21.49 32 0 53.49 0 80v328.4l90.54-181.1C101.4 205.6 123.4 192 147.8 192zM543.1 224H147.8C135.7 224 124.6 230.8 119.2 241.7L0 480h447.1c12.12 0 23.2-6.852 28.62-17.69l96-192C583.2 249 567.7 224 543.1 224z"
          ></path>
        </svg>
      </button>
      <button id="btnUndo" class="disabled" disabled>
        <svg
          width="28"
          height="28"
          viewBox="0 0 1000 1000"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0 960) scale(-1,1) rotate(180)"
            d="M762 -64q43 77 62 168t-9 168t-113.5 127.5t-253.5 46.5v-254l-384 384l384 384v-248q201 5 314.5 -73t148.5 -196t-4.5 -255.5t-144.5 -251.5z"
          />
        </svg>
      </button>
      <button id="btnRedo" class="disabled" disabled>
        <svg
          width="28"
          height="28"
          viewBox="0 0 1000 1000"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0 960) scale(-1,1) rotate(180)"
            d="M576 712v248l384 -384l-384 -384v254q-168 4 -253.5 -46.5t-113.5 -127.5t-9 -168t62 -168q-105 114 -144.5 251.5t-4.5 255.5t148.5 196t314.5 73v0z"
          />
        </svg>
      </button>
      <button id="btnFlipH">
        <svg
          width="28"
          height="28"
          viewBox="0 0 512 417.79"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M333.55 16.79 511 392.75c2.46 5.22.22 11.45-4.99 13.91-1.45.68-2.97 1.01-4.46 1l-177.77.03c-5.78 0-10.47-4.7-10.47-10.48V20.58c0-5.78 4.69-10.47 10.47-10.47 4.44 0 8.25 2.77 9.77 6.68zM240.3 402.16c0 18.18 26.25 21.89 30.98 3.74.28-1.29.45-2.4.45-3.74v-9.45c0-18.18-26.25-21.89-30.98-3.74-.28 1.29-.45 2.4-.45 3.74v9.45zm0-72.3c0 18.18 26.25 21.89 30.98 3.74.28-1.29.45-2.4.45-3.74v-31.42c0-18.18-26.25-21.89-30.98-3.74-.28 1.29-.45 2.4-.45 3.74v31.42zm0-94.27c0 18.18 26.25 21.89 30.98 3.74.28-1.29.45-2.4.45-3.74v-31.42c0-18.18-26.25-21.89-30.98-3.73-.28 1.28-.45 2.39-.45 3.73v31.42zm0-94.26c0 18.17 26.25 21.88 30.98 3.73.28-1.28.45-2.39.45-3.73V109.9c0-18.17-26.25-21.89-30.98-3.73-.28 1.28-.45 2.39-.45 3.73v31.43zm0-94.27c0 18.17 26.25 21.89 30.98 3.73.28-1.28.45-2.39.45-3.73V15.63c0-18.17-26.25-21.88-30.98-3.73-.28 1.29-.45 2.39-.45 3.73v31.43zM1.33 392.11 178.79 16.12c2.46-5.21 8.7-7.45 13.91-4.99 3.78 1.78 5.99 5.54 5.99 9.45l.04 376.63c0 5.78-4.7 10.48-10.48 10.48H10.48c-5.79 0-10.48-4.7-10.48-10.48 0-1.85.48-3.59 1.33-5.1zm483.72-5.37L334.26 67.26v319.48h150.79z"
          />
        </svg>
      </button>
      <button id="btnFlipV">
        <svg
          width="28"
          height="28"
          viewBox="0 0 428 512.54"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="m72.21 334.61 319.82 150.95V334.61H72.21zm-56.56-94.06c-18.2 0-21.91 26.27-3.74 31.01 1.29.28 2.4.45 3.74.45h19.23c18.2 0 21.91-26.27 3.74-31.01-1.29-.28-2.4-.45-3.74-.45H15.65zm82.14 0c-18.2 0-21.91 26.27-3.74 31.01 1.29.28 2.4.45 3.74.45h31.46c18.19 0 21.91-26.27 3.74-31.01-1.29-.28-2.4-.45-3.74-.45H97.79zm94.37 0c-18.2 0-21.91 26.27-3.74 31.01 1.29.28 2.4.45 3.74.45h31.45c18.2 0 21.92-26.27 3.74-31.01-1.28-.28-2.39-.45-3.74-.45h-31.45zm94.37 0c-18.2 0-21.92 26.27-3.74 31.01 1.28.28 2.39.45 3.74.45h31.45c18.2 0 21.91-26.27 3.74-31.01-1.29-.28-2.4-.45-3.74-.45h-31.45zm94.36 0c-18.19 0-21.91 26.27-3.74 31.01 1.29.28 2.4.45 3.74.45h31.46c18.2 0 21.91-26.27 3.74-31.01-1.29-.28-2.4-.45-3.74-.45h-31.46zM21.02 178.98 397.41 1.33c1.51-.85 3.25-1.33 5.1-1.33C408.3 0 413 4.7 413 10.49v177.96c0 5.79-4.7 10.48-10.49 10.48H25.49c-3.92-.03-7.68-2.25-9.47-6.03-2.46-5.22-.22-11.46 5-13.92zm377.03 332.56L21.69 333.9c-3.91-1.53-6.69-5.33-6.69-9.78 0-5.79 4.7-10.48 10.49-10.48h377.02c5.79 0 10.49 4.69 10.49 10.48v177.95c-.02 1.5-.35 3.02-1.03 4.47-2.46 5.22-8.7 7.46-13.92 5z"
          />
        </svg>
      </button>
      <button id="btnCrop">
        <svg
          width="28"
          height="28"
          viewBox="0 0 512 512"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="m373.4 512c-18.9 0-34.2-15.3-34.2-34.2v-70.1h-200.6c-18.9 0-34.2-15.3-34.2-34.2v-200.6h-70.2c-18.9.3-34.5-14.7-34.8-33.6s14.7-34.5 33.6-34.8h1.2 70.1v-70.3c-.2-18.9 14.8-34.5 33.7-34.8s34.5 14.7 34.8 33.6v1.2 70.1h200.5c18.9 0 34.2 15.3 34.2 34.2v200.5h70.1c18.9 0 34.2 15.3 34.2 34.2s-15.3 34.2-34.2 34.2h-70.1v70.1c.1 19.2-15.2 34.5-34.1 34.5zm-34.3-172.9v-166.2h-166.2v166.3h166.2z"
          />
        </svg>
      </button>
      <button id="btnRotateRight">
        <svg
          width="28"
          height="28"
          viewBox="0 0 512 512"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="m446 136.6h-275.3c-27.6 0-50 22.4-50 50v275.4c0 27.6 22.4 50 50 50h275.3c27.6 0 50-22.4 50-50v-275.4c0-27.6-22.3-50-50-50z"
          />
          <path
            d="m342.5 80.2-.9 20.8c-.5 12 15 17.1 21.7 7.2l33.3-48.9c3.9-5.7 3.3-13.4-1.5-18.5l-35-37c-7.8-8.3-21.7-1.9-20.4 9.5l2.1 18.7h-187.4c-76.5-.1-138.4 61.9-138.4 138.3v180.9c0 13.3 10.8 24.1 24.2 24.1 13.3 0 24.1-10.8 24.2-24.1v-181.5c0-49.4 40-89.4 89.4-89.4h188.7z"
          />
        </svg>
      </button>
      <button id="btnRotateLeft">
        <svg
          width="28"
          height="28"
          viewBox="0 0 512 512"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="m341.3 136.6h-275.3c-27.6 0-50 22.4-50 50v275.4c0 27.6 22.4 50 50 50h275.4c27.6 0 50-22.4 50-50v-275.4c-.1-27.6-22.4-50-50.1-50z"
          />
          <path
            d="m357.6 31.9h-187.4l2.1-18.7c1.3-11.3-12.6-17.8-20.4-9.5l-34.9 37.1c-4.8 5-5.4 12.7-1.5 18.5l33.3 48.9c6.7 9.9 22.2 4.8 21.7-7.2l-.9-20.8h188.8c49.4 0 89.5 40 89.5 89.4v181.6c0 13.3 10.8 24.1 24.1 24.1 13.3 0 24.2-10.8 24.2-24.1v-180.9c-.2-76.4-62.1-138.4-138.6-138.4z"
          />
        </svg>
      </button>
      <button id="btnResize">
        <svg
          width="28"
          height="28"
          viewBox="0 0 512 512"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="scale(0.85, 0.85) translate(55, 55)"
            d="M496,0H304c-8.832,0-16,7.168-16,16v32c0,8.832,7.168,16,16,16h98.752L64,402.752V304c0-8.832-7.168-16-16-16H16 c-8.832,0-16,7.168-16,16v192c0,8.832,7.168,16,16,16h192c8.832,0,16-7.168,16-16v-32c0-8.832-7.168-16-16-16h-98.752L448,109.248 V208c0,8.832,7.168,16,16,16h32c8.832,0,16-7.168,16-16V16C512,7.168,504.832,0,496,0z"
          />
        </svg>
      </button>
      <button id="btnMergeH">
        <svg
          width="28"
          height="28"
          viewBox="0 0 64 64"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect height="56" rx="1.077" width="22.077" x="6.423" y="4" />
          <rect height="56" rx="1.077" width="22.077" x="35.5" y="4" />
        </svg>
      </button>
      <button id="btnMergeV">
        <svg
          width="28"
          height="28"
          viewBox="0 0 64 64"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect height="22.077" rx="1.077" width="56" x="4" y="35.5" />
          <rect height="22.077" rx="1.077" width="56" x="4" y="6.423" />
        </svg>
      </button>
      <input type="file" id="mergeFileSelector" accept="image/*,.svg,.svg+xml">
      <hr>
      <button id="btnDrawSquare">
        <svg
          width="28"
          height="28"
          viewBox="0 0 32 32"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect x="6" y="6" width="20" height="20" rx="2" ry="2" />
        </svg>
      </button>
      <button id="btnDrawSquareOutline">
        <svg
          width="28"
          height="28"
          viewBox="0 0 32 32"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect
            x="6"
            y="6"
            width="20"
            height="20"
            rx="2"
            ry="2"
            fill="none"
            stroke="#000"
            stroke-width="3"
          />
        </svg>
      </button>
      <button id="btnDrawLine">
        <svg
          width="28"
          height="28"
          viewBox="0 0 32 32"
          xmlns="http://www.w3.org/2000/svg"
        >
          <line
            x1="7"
            y1="25"
            x2="25"
            y2="7"
            stroke="#000"
            stroke-width="3"
            stroke-linecap="round"
          />
        </svg>
      </button>
      <button id="btnDrawCircle">
        <svg
          width="28"
          height="28"
          viewBox="0 0 32 32"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="16" cy="16" r="10" />
        </svg>
      </button>
      <button id="btnDrawCircleOutline">
        <svg
          width="28"
          height="28"
          viewBox="0 0 32 32"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle
            cx="16"
            cy="16"
            r="10"
            fill="none"
            stroke="#000"
            stroke-width="3"
          />
        </svg>
      </button>
      <hr>
      <div class="color-picker disabled" id="colorPicker">
        <div class="color-picker-preview" id="colorPreview"></div>
        <input
          type="text"
          id="inputShapeColorHex"
          class="color-picker-input"
          value="#ff0000"
          maxlength="7"
          autocomplete="off"
          spellcheck="false"
        >
        <input
          type="text"
          id="inputShapeColorRgb"
          class="color-picker-input"
          value="255,0,0"
          autocomplete="off"
          spellcheck="false"
        >
      </div>
      <hr>
      <div class="containerResize">
        <input type="number" id="inputWidth" min="1">
        <input type="number" id="inputHeight" min="1">
        <label id="keepRatioLabel">
          <input type="checkbox" id="checkKeepRatio" checked>
          <span id="labelKeepRatio"></span
        ></label>
      </div>
      <hr>
      <div id="labelBinary" class="title"></div>
      <button id="btnDownloadJPG">
        <svg
          width="28"
          height="28"
          viewBox="0 0 50 51"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0,4)"
            d="m27.0833 17.3945c.863 0 1.5625.6996 1.5625 1.5625v6.25c0 .4144-.1646.8119-.4576 1.1049s-.6905.4576-1.1049.4576h-4.6875v4.6875c0 .863-.6995 1.5625-1.5625 1.5625-.8629 0-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.1647-.8118.4577-1.1048s.6904-.4577 1.1048-.4577zm-4.6875 6.25h3.125v-3.125h-3.125z"
          />
          <path
            transform="translate(0,4)"
            d="m32.2285 32.5619c-.293-.293-.4577-.6905-.4577-1.1049v-12.5c0-.8629.6996-1.5625 1.5625-1.5625h6.25c.863 0 1.5625.6996 1.5625 1.5625 0 .863-.6995 1.5625-1.5625 1.5625h-4.6875v9.375h3.125v-3.4375c0-.8629.6996-1.5625 1.5625-1.5625.863 0 1.5625.6996 1.5625 1.5625v5c0 .863-.6995 1.5625-1.5625 1.5625h-6.25c-.4144 0-.8118-.1646-1.1048-.4576z"
          />
          <path
            transform="translate(0,4)"
            d="m10.4067 29.8946c-.85836.0053-1.55254.7028-1.55253 1.5624.00001.863.69957 1.5625 1.56253 1.5625v-1.5625 1.5625h.0029.0034.0079l.0204-.0002.059-.0014c.0471-.0014.1097-.004.1857-.0089.1513-.0097.3585-.0286.6035-.0654.4822-.0723 1.1515-.2198 1.8417-.5304.6923-.3116 1.4556-.8102 2.0466-1.6082.6046-.8161.958-1.8509.958-3.0979v-8.748c0-.863-.6995-1.5646-1.5625-1.5646-.8629 0-1.5625.6996-1.5625 1.5625v8.7501c0 .6279-.1674.9993-.3441 1.2379-.1902.2567-.4685.4612-.8179.6184-.3514.1581-.7238.245-1.0229.2898-.1456.0219-.2639.0323-.3404.0372-.0381.0025-.065.0035-.0789.0039z"
          />
        </svg>
      </button>
      <button id="btnDownloadPNG">
        <svg
          width="28"
          height="28"
          viewBox="0 0 50 51"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0,4)"
            d="m15.625 17.3945c.8629 0 1.5625.6996 1.5625 1.5625v6.25c0 .4144-.1646.8119-.4577 1.1049-.293.293-.6904.4576-1.1048.4576h-4.6875v4.6875c0 .863-.6996 1.5625-1.56252 1.5625-.86295 0-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.16462-.8118.45765-1.1048.29302-.293.69045-.4577 1.10485-.4577zm-4.6875 6.25h3.125v-3.125h-3.125z"
          />
          <path
            transform="translate(0,4)"
            d="m21.875 33.0195c-.863 0-1.5625-.6995-1.5625-1.5625v-12.5c0-.7246.4982-1.3542 1.2035-1.5207s1.4324.1738 1.7565.822l3.29 6.5799v-5.8812c0-.8629.6995-1.5625 1.5625-1.5625.8629 0 1.5625.6996 1.5625 1.5625v12.5c0 .7247-.4983 1.3542-1.2035 1.5207-.7053.1665-1.4325-.1737-1.7566-.8219l-3.2899-6.5799v5.8811c0 .863-.6996 1.5625-1.5625 1.5625z"
          />
          <path
            transform="translate(0,4)"
            d="m33.2701 32.5619c-.293-.293-.4576-.6905-.4576-1.1049v-12.5c0-.8629.6995-1.5625 1.5625-1.5625h6.25c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-4.6875v9.375h3.125v-3.4375c0-.8629.6995-1.5625 1.5625-1.5625.8629 0 1.5625.6996 1.5625 1.5625v5c0 .863-.6996 1.5625-1.5625 1.5625h-6.25c-.4144 0-.8118-.1646-1.1049-.4576z"
          />
        </svg>
      </button>
      <button id="btnDownloadWEBP">
        <svg
          width="28"
          height="28"
          viewBox="0 0 50 51"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0,4)"
            d="m33.125 17.3945c1.5533 0 2.8125 1.2592 2.8125 2.8125v1.875c0 2.5889-2.0987 4.6875-4.6875 4.6875v-3.125c.8629 0 1.5625-.6995 1.5625-1.5625v-1.5625h-3.125v10.9375c0 .863-.6996 1.5625-1.5625 1.5625s-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.1646-.8118.4576-1.1048.2931-.293.6905-.4577 1.1049-.4577z"
          />
          <path
            transform="translate(0,4)"
            d="m33.125 33.0195c1.5533 0 2.8125-1.2592 2.8125-2.8125v-1.875c0-2.5888-2.0987-4.6875-4.6875-4.6875h-3.125c-.8629 0-1.5625.6996-1.5625 1.5625 0 .863.6996 1.5625 1.5625 1.5625h3.125c.8629 0 1.5625.6996 1.5625 1.5625v1.5625h-4.6875c-.8629 0-1.5625.6996-1.5625 1.5625 0 .863.6996 1.5625 1.5625 1.5625z"
          />
          <path
            transform="translate(0,4)"
            d="m46.875 17.3945c.8629 0 1.5625.6996 1.5625 1.5625v6.25c0 .4144-.1646.8119-.4576 1.1049-.2931.293-.6905.4576-1.1049.4576h-4.6875v4.6875c0 .863-.6996 1.5625-1.5625 1.5625s-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.1646-.8118.4576-1.1048.2931-.293.6905-.4577 1.1049-.4577zm-4.6875 6.25h3.125v-3.125h-3.125z"
          />
          <path
            transform="translate(0,4)"
            d="m3.125 17.3945c.86294 0 1.5625.6996 1.5625 1.5625v5.8812l.16496-.3299c.26467-.5294.80571-.8638 1.39754-.8638s1.13287.3344 1.39754.8638l.16496.3299v-5.8812c0-.8629.69955-1.5625 1.5625-1.5625.8629 0 1.5625.6996 1.5625 1.5625v12.5c0 .7247-.4982 1.3542-1.20351 1.5207-.70527.1665-1.43246-.1737-1.75653-.8219l-1.72746-3.4549-1.72746 3.4549c-.32407.6482-1.05126.9884-1.75653.8219s-1.20351-.796-1.20351-1.5207v-12.5c0-.8629.69956-1.5625 1.5625-1.5625z"
          />
          <path
            transform="translate(0,4)"
            d="m14.5201 32.5619c-.293-.293-.4576-.6905-.4576-1.1049v-12.5c0-.8629.6996-1.5625 1.5625-1.5625h6.25c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-4.6875v9.375h4.6875c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-6.25c-.4144 0-.8118-.1646-1.1049-.4576z"
          />
          <path
            transform="translate(0,4)"
            d="m14.0625 25.207c0-.8629.6996-1.5625 1.5625-1.5625h4.1667c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-4.1667c-.8629 0-1.5625-.6995-1.5625-1.5625z"
          />
        </svg>
      </button>
      <hr>
      <div id="labelBase64" class="title">Base64</div>
      <button id="btnDownloadJPGBase64">
        <svg
          width="28"
          height="28"
          viewBox="0 0 50 51"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0,4)"
            d="m27.0833 17.3945c.863 0 1.5625.6996 1.5625 1.5625v6.25c0 .4144-.1646.8119-.4576 1.1049s-.6905.4576-1.1049.4576h-4.6875v4.6875c0 .863-.6995 1.5625-1.5625 1.5625-.8629 0-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.1647-.8118.4577-1.1048s.6904-.4577 1.1048-.4577zm-4.6875 6.25h3.125v-3.125h-3.125z"
          />
          <path
            transform="translate(0,4)"
            d="m32.2285 32.5619c-.293-.293-.4577-.6905-.4577-1.1049v-12.5c0-.8629.6996-1.5625 1.5625-1.5625h6.25c.863 0 1.5625.6996 1.5625 1.5625 0 .863-.6995 1.5625-1.5625 1.5625h-4.6875v9.375h3.125v-3.4375c0-.8629.6996-1.5625 1.5625-1.5625.863 0 1.5625.6996 1.5625 1.5625v5c0 .863-.6995 1.5625-1.5625 1.5625h-6.25c-.4144 0-.8118-.1646-1.1048-.4576z"
          />
          <path
            transform="translate(0,4)"
            d="m10.4067 29.8946c-.85836.0053-1.55254.7028-1.55253 1.5624.00001.863.69957 1.5625 1.56253 1.5625v-1.5625 1.5625h.0029.0034.0079l.0204-.0002.059-.0014c.0471-.0014.1097-.004.1857-.0089.1513-.0097.3585-.0286.6035-.0654.4822-.0723 1.1515-.2198 1.8417-.5304.6923-.3116 1.4556-.8102 2.0466-1.6082.6046-.8161.958-1.8509.958-3.0979v-8.748c0-.863-.6995-1.5646-1.5625-1.5646-.8629 0-1.5625.6996-1.5625 1.5625v8.7501c0 .6279-.1674.9993-.3441 1.2379-.1902.2567-.4685.4612-.8179.6184-.3514.1581-.7238.245-1.0229.2898-.1456.0219-.2639.0323-.3404.0372-.0381.0025-.065.0035-.0789.0039z"
          />
        </svg>
      </button>
      <button id="btnDownloadPNGBase64">
        <svg
          width="28"
          height="28"
          viewBox="0 0 50 51"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0,4)"
            d="m15.625 17.3945c.8629 0 1.5625.6996 1.5625 1.5625v6.25c0 .4144-.1646.8119-.4577 1.1049-.293.293-.6904.4576-1.1048.4576h-4.6875v4.6875c0 .863-.6996 1.5625-1.56252 1.5625-.86295 0-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.16462-.8118.45765-1.1048.29302-.293.69045-.4577 1.10485-.4577zm-4.6875 6.25h3.125v-3.125h-3.125z"
          />
          <path
            transform="translate(0,4)"
            d="m21.875 33.0195c-.863 0-1.5625-.6995-1.5625-1.5625v-12.5c0-.7246.4982-1.3542 1.2035-1.5207s1.4324.1738 1.7565.822l3.29 6.5799v-5.8812c0-.8629.6995-1.5625 1.5625-1.5625.8629 0 1.5625.6996 1.5625 1.5625v12.5c0 .7247-.4983 1.3542-1.2035 1.5207-.7053.1665-1.4325-.1737-1.7566-.8219l-3.2899-6.5799v5.8811c0 .863-.6996 1.5625-1.5625 1.5625z"
          />
          <path
            transform="translate(0,4)"
            d="m33.2701 32.5619c-.293-.293-.4576-.6905-.4576-1.1049v-12.5c0-.8629.6995-1.5625 1.5625-1.5625h6.25c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-4.6875v9.375h3.125v-3.4375c0-.8629.6995-1.5625 1.5625-1.5625.8629 0 1.5625.6996 1.5625 1.5625v5c0 .863-.6996 1.5625-1.5625 1.5625h-6.25c-.4144 0-.8118-.1646-1.1049-.4576z"
          />
        </svg>
      </button>
      <button id="btnDownloadWEBPBase64">
        <svg
          width="28"
          height="28"
          viewBox="0 0 50 51"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            transform="translate(0,4)"
            d="m33.125 17.3945c1.5533 0 2.8125 1.2592 2.8125 2.8125v1.875c0 2.5889-2.0987 4.6875-4.6875 4.6875v-3.125c.8629 0 1.5625-.6995 1.5625-1.5625v-1.5625h-3.125v10.9375c0 .863-.6996 1.5625-1.5625 1.5625s-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.1646-.8118.4576-1.1048.2931-.293.6905-.4577 1.1049-.4577z"
          />
          <path
            transform="translate(0,4)"
            d="m33.125 33.0195c1.5533 0 2.8125-1.2592 2.8125-2.8125v-1.875c0-2.5888-2.0987-4.6875-4.6875-4.6875h-3.125c-.8629 0-1.5625.6996-1.5625 1.5625 0 .863.6996 1.5625 1.5625 1.5625h3.125c.8629 0 1.5625.6996 1.5625 1.5625v1.5625h-4.6875c-.8629 0-1.5625.6996-1.5625 1.5625 0 .863.6996 1.5625 1.5625 1.5625z"
          />
          <path
            transform="translate(0,4)"
            d="m46.875 17.3945c.8629 0 1.5625.6996 1.5625 1.5625v6.25c0 .4144-.1646.8119-.4576 1.1049-.2931.293-.6905.4576-1.1049.4576h-4.6875v4.6875c0 .863-.6996 1.5625-1.5625 1.5625s-1.5625-.6995-1.5625-1.5625v-12.5c0-.4144.1646-.8118.4576-1.1048.2931-.293.6905-.4577 1.1049-.4577zm-4.6875 6.25h3.125v-3.125h-3.125z"
          />
          <path
            transform="translate(0,4)"
            d="m3.125 17.3945c.86294 0 1.5625.6996 1.5625 1.5625v5.8812l.16496-.3299c.26467-.5294.80571-.8638 1.39754-.8638s1.13287.3344 1.39754.8638l.16496.3299v-5.8812c0-.8629.69955-1.5625 1.5625-1.5625.8629 0 1.5625.6996 1.5625 1.5625v12.5c0 .7247-.4982 1.3542-1.20351 1.5207-.70527.1665-1.43246-.1737-1.75653-.8219l-1.72746-3.4549-1.72746 3.4549c-.32407.6482-1.05126.9884-1.75653.8219s-1.20351-.796-1.20351-1.5207v-12.5c0-.8629.69956-1.5625 1.5625-1.5625z"
          />
          <path
            transform="translate(0,4)"
            d="m14.5201 32.5619c-.293-.293-.4576-.6905-.4576-1.1049v-12.5c0-.8629.6996-1.5625 1.5625-1.5625h6.25c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-4.6875v9.375h4.6875c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-6.25c-.4144 0-.8118-.1646-1.1049-.4576z"
          />
          <path
            transform="translate(0,4)"
            d="m14.0625 25.207c0-.8629.6996-1.5625 1.5625-1.5625h4.1667c.8629 0 1.5625.6996 1.5625 1.5625 0 .863-.6996 1.5625-1.5625 1.5625h-4.1667c-.8629 0-1.5625-.6995-1.5625-1.5625z"
          />
        </svg>
      </button>
    </div>
    <div class="workspace">
      <canvas id="canvas"></canvas>
    </div>
    <script>
      var APP_STRINGS = {
        en: {
          width: "Width",
          height: "Height",
          binary: "Binary",
          setSize: "Set the image size",
          accept: "Accept",
          cancel: "Cancel",
          keepRatio: "Keep ratio",
        },
        es: {
          width: "Ancho",
          height: "Alto",
          binary: "Binario",
          setSize: "Fijar tama\u00F1o de imagen",
          accept: "Aceptar",
          cancel: "Cancelar",
          keepRatio: "Proporci\u00F3n fija",
        },
      }

      var USER_LANG = window.navigator.language.substring(0, 2).toLowerCase()
      var GET_APP_STRING = APP_STRINGS[USER_LANG] || APP_STRINGS["en"]

      function t(stringName) {
        return GET_APP_STRING[stringName] || ""
      }

      var btnOpen
      var btnFlipH
      var btnFlipV
      var btnRotateRight
      var btnRotateLeft
      var btnCrop
      var btnMergeH
      var btnMergeV
      var btnResize
      var inputWidth
      var inputHeight
      var checkKeepRatio
      var labelKeepRatio
      var keepRatioLabel
      var labelBinary
      var btnDownloadJPG
      var btnDownloadPNG
      var btnDownloadWEBP
      var labelBase64
      var btnDownloadJPGBase64
      var btnDownloadPNGBase64
      var btnDownloadWEBPBase64
      var fileSelector
      var mergeFileSelector
      var btnUndo
      var btnRedo
      var btnDrawSquare
      var btnDrawSquareOutline
      var btnDrawCircle
      var btnDrawCircleOutline
      var btnDrawLine
      var colorPicker
      var colorPreview
      var inputShapeColorHex
      var inputShapeColorRgb

      var canvas
      var ctx

      var img = new Image()
      var mergeImg = new Image()
      var startX
      var startY
      var updating
      var displayScaleX = 1
      var displayScaleY = 1
      var isCropping = false
      var isResizing = false
      var resizeHandle = null
      var handles = []
      var HANDLE_SIZE = 8
      var ratio = 1
      var currentSelection = null
      var originalFileName = null
      var mustMergeHorizontal = false
      var activeTool = null
      var isDrawingShape = false
      var shapeColor = "#ff0000"
      var isUpdatingColorInputs = false
      var undoStack = []
      var redoStack = []

      function clearSelection() {
        if (currentSelection) {
          currentSelection = null
          ctx.clearRect(0, 0, canvas.width, canvas.height)
          ctx.drawImage(img, 0, 0)
        }
      }

      function rotate(deg) {
        if (!canvas || !canvas.width || !canvas.height) {
          return
        }
        clearSelection()
        captureUndoState()

        var tmp = document.createElement("canvas")
        var tctx = tmp.getContext("2d")

        // swap width/height for 90 or 270 degrees rotations
        if (Math.abs(deg) === 90 || Math.abs(deg) === 270) {
          tmp.width = canvas.height
          tmp.height = canvas.width
        } else {
          tmp.width = canvas.width
          tmp.height = canvas.height
        }

        // move origin to center and rotate
        tctx.translate(tmp.width / 2, tmp.height / 2)
        tctx.rotate((deg * Math.PI) / 180)

        // draw the image offset to center
        tctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2)

        // replace the main canvas content
        canvas.width = tmp.width
        canvas.height = tmp.height
        ctx.drawImage(tmp, 0, 0)

        // update image source
        syncImageFromCanvas()

        // update ratio and input values
        ratio = canvas.width / canvas.height
        inputWidth.value = canvas.width
        inputHeight.value = canvas.height
        displayScaleX = canvas.clientWidth / canvas.width
        displayScaleY = canvas.clientHeight / canvas.height
      }

      function flip(horizontal, vertical) {
        if (!canvas || !canvas.width || !canvas.height) {
          return
        }
        clearSelection()
        captureUndoState()

        var tmp = document.createElement("canvas")
        tmp.width = canvas.width
        tmp.height = canvas.height
        var tctx = tmp.getContext("2d")
        tctx.translate(horizontal ? tmp.width : 0, vertical ? tmp.height : 0)
        tctx.scale(horizontal ? -1 : 1, vertical ? -1 : 1)
        tctx.drawImage(canvas, 0, 0)
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        ctx.drawImage(tmp, 0, 0)
        syncImageFromCanvas()
      }

      function mergeImages(horizontal) {
        if (!img.src || !mergeImg.src) {
          return
        }

        clearSelection()
        captureUndoState()

        var newCanvas = document.createElement("canvas")
        var newCtx = newCanvas.getContext("2d")

        var mergeW = mergeImg.width
        var mergeH = mergeImg.height
        var scale

        if (horizontal) {
          // scale mergeimg to match img height
          scale = img.height / mergeImg.height
          mergeW = mergeImg.width * scale
          mergeH = img.height

          newCanvas.width = img.width + mergeW
          newCanvas.height = img.height

          newCtx.drawImage(img, 0, 0)
          newCtx.drawImage(mergeImg, img.width, 0, mergeW, mergeH)
        } else {
          // scale mergeimg to match img width
          scale = img.width / mergeImg.width
          mergeW = img.width
          mergeH = mergeImg.height * scale

          newCanvas.width = img.width
          newCanvas.height = img.height + mergeH

          newCtx.drawImage(img, 0, 0)
          newCtx.drawImage(mergeImg, 0, img.height, mergeW, mergeH)
        }

        canvas.width = newCanvas.width
        canvas.height = newCanvas.height
        ctx.drawImage(newCanvas, 0, 0)
        syncImageFromCanvas()
        ratio = canvas.width / canvas.height
        inputWidth.value = canvas.width
        inputHeight.value = canvas.height
        displayScaleX = canvas.clientWidth / canvas.width
        displayScaleY = canvas.clientHeight / canvas.height

        mergeFileSelector.value = null
      }

      function downloadImage(format, convertToBase64) {
        if (!originalFileName) {
          return
        }

        clearSelection()
        var link = document.createElement("a")
        var canvasToUse = canvas

        if (format === "jpeg") {
          var tmp = document.createElement("canvas")
          tmp.width = canvas.width
          tmp.height = canvas.height
          var tctx = tmp.getContext("2d")
          tctx.fillStyle = "#fff"
          tctx.fillRect(0, 0, tmp.width, tmp.height)
          tctx.drawImage(canvas, 0, 0)
          canvasToUse = tmp
        }

        if (convertToBase64) {
          var base64String = canvasToUse.toDataURL("image/" + format)
          var blob = new Blob([base64String], { type: "text/plain" })
          link.download =
            originalFileName +
            "-base64-" +
            (format === "jpeg" ? "jpg" : format) +
            ".txt"
          link.href = URL.createObjectURL(blob)
        } else {
          link.href = canvasToUse.toDataURL("image/" + format)
          if (format === "jpeg") {
            format = "jpg"
          }
          link.download = originalFileName + "." + format
        }

        link.click()
        URL.revokeObjectURL(link.href)
        link.remove()
      }

      function enableAll(preserveHistory) {
        disableAll(!!preserveHistory)
        btnFlipH.disabled = false
        btnFlipH.classList.remove("disabled")
        btnFlipV.disabled = false
        btnFlipV.classList.remove("disabled")
        btnRotateRight.disabled = false
        btnRotateRight.classList.remove("disabled")
        btnRotateLeft.disabled = false
        btnRotateLeft.classList.remove("disabled")
        btnCrop.disabled = false
        btnCrop.classList.remove("disabled")
        btnMergeH.disabled = false
        btnMergeH.classList.remove("disabled")
        btnMergeV.disabled = false
        btnMergeV.classList.remove("disabled")
        btnResize.disabled = false
        btnResize.classList.remove("disabled")
        inputWidth.disabled = false
        inputHeight.disabled = false
        keepRatioLabel.classList.remove("disabled")
        checkKeepRatio.disabled = false
        btnDrawSquare.disabled = false
        btnDrawSquare.classList.remove("disabled")
        if (btnDrawSquareOutline) {
          btnDrawSquareOutline.disabled = false
          btnDrawSquareOutline.classList.remove("disabled")
        }
        btnDrawCircle.disabled = false
        btnDrawCircle.classList.remove("disabled")
        if (btnDrawCircleOutline) {
          btnDrawCircleOutline.disabled = false
          btnDrawCircleOutline.classList.remove("disabled")
        }
        btnDrawLine.disabled = false
        btnDrawLine.classList.remove("disabled")
        setColorPickerEnabled(true)
        updateColorUI(shapeColor)
        labelBinary.classList.remove("disabled")
        btnDownloadJPG.disabled = false
        btnDownloadJPG.classList.remove("disabled")
        btnDownloadPNG.disabled = false
        btnDownloadPNG.classList.remove("disabled")
        btnDownloadWEBP.disabled = false
        btnDownloadWEBP.classList.remove("disabled")
        labelBase64.classList.remove("disabled")
        btnDownloadJPGBase64.disabled = false
        btnDownloadJPGBase64.classList.remove("disabled")
        btnDownloadPNGBase64.disabled = false
        btnDownloadPNGBase64.classList.remove("disabled")
        btnDownloadWEBPBase64.disabled = false
        btnDownloadWEBPBase64.classList.remove("disabled")
        updateUndoRedoButtons()
      }

      function disableAll(preserveHistory) {
        var keepState = !!preserveHistory
        btnFlipH.disabled = true
        btnFlipH.classList.add("disabled")
        btnFlipV.disabled = true
        btnFlipV.classList.add("disabled")
        btnRotateRight.disabled = true
        btnRotateRight.classList.add("disabled")
        btnRotateLeft.disabled = true
        btnRotateLeft.classList.add("disabled")
        btnCrop.disabled = true
        btnCrop.classList.add("disabled")
        btnMergeH.disabled = true
        btnMergeH.classList.add("disabled")
        btnMergeV.disabled = true
        btnMergeV.classList.add("disabled")
        btnResize.disabled = true
        btnResize.classList.add("disabled")
        inputWidth.disabled = true
        inputHeight.disabled = true
        keepRatioLabel.classList.add("disabled")
        checkKeepRatio.disabled = true
        btnDrawSquare.disabled = true
        btnDrawSquare.classList.add("disabled")
        if (!keepState) {
          btnDrawSquare.classList.remove("selected")
        }
        btnDrawCircle.disabled = true
        btnDrawCircle.classList.add("disabled")
        if (!keepState) {
          btnDrawCircle.classList.remove("selected")
        }
        btnDrawLine.disabled = true
        btnDrawLine.classList.add("disabled")
        if (!keepState) {
          btnDrawLine.classList.remove("selected")
        }
        if (btnDrawSquareOutline) {
          btnDrawSquareOutline.disabled = true
          btnDrawSquareOutline.classList.add("disabled")
          if (!keepState) {
            btnDrawSquareOutline.classList.remove("selected")
          }
        }
        if (btnDrawCircleOutline) {
          btnDrawCircleOutline.disabled = true
          btnDrawCircleOutline.classList.add("disabled")
          if (!keepState) {
            btnDrawCircleOutline.classList.remove("selected")
          }
        }
        setColorPickerEnabled(false)
        if (!keepState) {
          setActiveTool(null)
        }
        labelBinary.classList.add("disabled")
        btnDownloadJPG.disabled = true
        btnDownloadJPG.classList.add("disabled")
        btnDownloadPNG.disabled = true
        btnDownloadPNG.classList.add("disabled")
        btnDownloadWEBP.disabled = true
        btnDownloadWEBP.classList.add("disabled")
        labelBase64.classList.add("disabled")
        btnDownloadJPGBase64.disabled = true
        btnDownloadJPGBase64.classList.add("disabled")
        btnDownloadPNGBase64.disabled = true
        btnDownloadPNGBase64.classList.add("disabled")
        btnDownloadWEBPBase64.disabled = true
        btnDownloadWEBPBase64.classList.add("disabled")
        if (btnUndo) {
          btnUndo.disabled = true
          btnUndo.classList.add("disabled")
        }
        if (btnRedo) {
          btnRedo.disabled = true
          btnRedo.classList.add("disabled")
        }
        if (!keepState) {
          resetHistory()
        }
      }

      function inputCustom(title, width, height, yes, no, callbackYes, callbackNo) {
        try {
          // creating the input container
          var inputContainer = document.createElement("div")
          inputContainer.style.position = "fixed"
          inputContainer.style.top = 0
          inputContainer.style.bottom = 0
          inputContainer.style.left = 0
          inputContainer.style.right = 0
          inputContainer.style.zIndex = 9999
          inputContainer.style.backgroundColor = "rgba(0,0,0,0.5)"

          // creating the input form
          var inputForm = document.createElement("div")
          inputForm.style.position = "relative"
          inputForm.style.top = "50%"
          inputForm.style.left = 0
          inputForm.style.right = 0
          inputForm.style.marginLeft = "auto"
          inputForm.style.marginRight = "auto"
          inputForm.style.transform = "translateY(-50%)"
          inputForm.style.borderRadius = "8px"
          inputForm.style.overflow = "hidden"
          inputForm.style.width = "300px"
          inputForm.style.backgroundColor = "#f2f2f2"
          inputForm.style.textAlign = "center"

          // creating the input title
          var inputTitle = document.createElement("div")
          inputTitle.style.textAlign = "left"
          inputTitle.style.paddingLeft = "10px"
          inputTitle.style.backgroundColor = "#3a76b1"
          inputTitle.style.fontFamily = "Arial"
          inputTitle.style.fontSize = "16px"
          inputTitle.style.fontWeight = "bold"
          inputTitle.style.color = "white"
          inputTitle.style.lineHeight = 2.5
          inputTitle.innerText = title

          // creating the input width
          var inputTextWidth = document.createElement("input")
          inputTextWidth.id = "inputTextWidth"
          inputTextWidth.type = "number"
          inputTextWidth.style.display = "block"
          inputTextWidth.style.borderRadius = "8px"
          inputTextWidth.style.overflow = "hidden"
          inputTextWidth.style.marginLeft = "auto"
          inputTextWidth.style.marginRight = "auto"
          inputTextWidth.style.marginTop = "15px"
          inputTextWidth.style.marginBottom = "15px"
          inputTextWidth.style.paddingLeft = "10px"
          inputTextWidth.style.paddingRight = "10px"
          inputTextWidth.style.border = "1px solid #b2b2b2"
          inputTextWidth.style.fontFamily = "Arial"
          inputTextWidth.style.fontSize = "16px"
          inputTextWidth.style.color = "black"
          inputTextWidth.style.textAlign = "left"
          inputTextWidth.style.lineHeight = 2
          inputTextWidth.style.width = "50%"
          inputTextWidth.placeholder = width
          inputTextWidth.addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
              // removing the input container
              document.getElementsByTagName("body")[0].removeChild(inputContainer)

              // executing the callback function
              if (typeof callbackYes === "function") {
                callbackYes(inputTextWidth.value, inputTextHeight.value)
              }
            } else if (event.key === "Escape") {
              // removing the input container
              document.getElementsByTagName("body")[0].removeChild(inputContainer)

              // executing the callback function
              if (typeof callbackNo === "function") {
                callbackNo()
              }
            }
          })

          // creating the input height
          var inputTextHeight = document.createElement("input")
          inputTextHeight.id = "inputTextHeight"
          inputTextHeight.type = "number"
          inputTextHeight.style.display = "block"
          inputTextHeight.style.borderRadius = "8px"
          inputTextHeight.style.overflow = "hidden"
          inputTextHeight.style.marginLeft = "auto"
          inputTextHeight.style.marginRight = "auto"
          inputTextHeight.style.marginTop = "15px"
          inputTextHeight.style.marginBottom = "15px"
          inputTextHeight.style.paddingLeft = "10px"
          inputTextHeight.style.paddingRight = "10px"
          inputTextHeight.style.border = "1px solid #b2b2b2"
          inputTextHeight.style.fontFamily = "Arial"
          inputTextHeight.style.fontSize = "16px"
          inputTextHeight.style.color = "black"
          inputTextHeight.style.textAlign = "left"
          inputTextHeight.style.lineHeight = 2
          inputTextHeight.style.width = "50%"
          inputTextHeight.placeholder = height
          inputTextHeight.addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
              // removing the input container
              document.getElementsByTagName("body")[0].removeChild(inputContainer)

              // executing the callback function
              if (typeof callbackYes === "function") {
                callbackYes(inputTextWidth.value, inputTextHeight.value)
              }
            } else if (event.key === "Escape") {
              // removing the input container
              document.getElementsByTagName("body")[0].removeChild(inputContainer)

              // executing the callback function
              if (typeof callbackNo === "function") {
                callbackNo()
              }
            }
          })

          // creating the input yes button
          var inputButtonYes = document.createElement("div")
          inputButtonYes.style.padding = "10px"
          inputButtonYes.style.backgroundColor = "#d2d2d2"
          inputButtonYes.style.border = "1px solid #b2b2b2"
          inputButtonYes.style.fontFamily = "Arial"
          inputButtonYes.style.fontSize = "16px"
          inputButtonYes.style.color = "black"
          inputButtonYes.style.textAlign = "center"
          inputButtonYes.style.lineHeight = 1.5
          inputButtonYes.style.display = "inline-block"
          inputButtonYes.style.borderRadius = "8px"
          inputButtonYes.style.overflow = "hidden"
          inputButtonYes.style.marginBottom = "10px"
          inputButtonYes.style.paddingLeft = "30px"
          inputButtonYes.style.paddingRight = "30px"
          inputButtonYes.style.cursor = "pointer"
          inputButtonYes.addEventListener("click", function () {
            // removing the input container
            document.getElementsByTagName("body")[0].removeChild(inputContainer)

            // executing the callback function
            if (typeof callbackYes === "function") {
              callbackYes(inputTextWidth.value, inputTextHeight.value)
            }
          })
          inputButtonYes.innerText = yes

          // creating the input no button
          var inputButtonNo = document.createElement("div")
          inputButtonNo.style.padding = "10px"
          inputButtonNo.style.backgroundColor = "#d2d2d2"
          inputButtonNo.style.border = "1px solid #b2b2b2"
          inputButtonNo.style.fontFamily = "Arial"
          inputButtonNo.style.fontSize = "16px"
          inputButtonNo.style.color = "black"
          inputButtonNo.style.textAlign = "center"
          inputButtonNo.style.lineHeight = 1.5
          inputButtonNo.style.display = "inline-block"
          inputButtonNo.style.borderRadius = "8px"
          inputButtonNo.style.overflow = "hidden"
          inputButtonNo.style.marginLeft = "20px"
          inputButtonNo.style.marginBottom = "10px"
          inputButtonNo.style.paddingLeft = "30px"
          inputButtonNo.style.paddingRight = "30px"
          inputButtonNo.style.cursor = "pointer"
          inputButtonNo.addEventListener("click", function () {
            // removing the input container
            document.getElementsByTagName("body")[0].removeChild(inputContainer)

            // executing the callback function
            if (typeof callbackNo === "function") {
              callbackNo()
            }
          })
          inputButtonNo.innerText = no

          // adding all the elements to the input container
          inputForm.appendChild(inputTitle)
          inputForm.appendChild(inputTextWidth)
          inputForm.appendChild(inputTextHeight)
          inputForm.appendChild(inputButtonYes)
          inputForm.appendChild(inputButtonNo)
          inputContainer.appendChild(inputForm)

          // adding the input container to the document
          document.getElementsByTagName("body")[0].appendChild(inputContainer)

          // forcing focus on the first input box
          setTimeout(function () {
            inputTextWidth.focus()
          }, 25)
        } catch (err) {
          //
        }
      }

      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v))
      }

      function sanitizeSelection(sel) {
        if (!sel) {
          return null
        }

        // default to zero if any value is missing or nan
        sel.x = isFinite(sel.x) ? sel.x : 0
        sel.y = isFinite(sel.y) ? sel.y : 0
        sel.width = isFinite(sel.width) ? sel.width : 0
        sel.height = isFinite(sel.height) ? sel.height : 0

        // clamp within canvas bounds
        sel.x = clamp(sel.x, 0, canvas.width)
        sel.y = clamp(sel.y, 0, canvas.height)
        sel.width = clamp(sel.width, 0, canvas.width - sel.x)
        sel.height = clamp(sel.height, 0, canvas.height - sel.y)

        // prevent negatives (in case of quick reverse dragging)
        if (sel.width < 0) {
          sel.width = 0
        }
        if (sel.height < 0) {
          sel.height = 0
        }

        return sel
      }

      function updateUndoRedoButtons() {
        if (!btnUndo || !btnRedo) {
          return
        }

        if (undoStack.length > 0) {
          btnUndo.disabled = false
          btnUndo.classList.remove("disabled")
        } else {
          btnUndo.disabled = true
          btnUndo.classList.add("disabled")
        }

        if (redoStack.length > 0) {
          btnRedo.disabled = false
          btnRedo.classList.remove("disabled")
        } else {
          btnRedo.disabled = true
          btnRedo.classList.add("disabled")
        }
      }

      function resetHistory() {
        undoStack = []
        redoStack = []
        updateUndoRedoButtons()
      }

      function captureUndoState() {
        if (!canvas || !canvas.width || !canvas.height || !originalFileName) {
          return
        }
        try {
          var currentState = canvas.toDataURL()
          if (
            !undoStack.length ||
            undoStack[undoStack.length - 1] !== currentState
          ) {
            undoStack.push(currentState)
          }
          redoStack = []
          updateUndoRedoButtons()
        } catch (err) {
          //
        }
      }

      function loadImageFromDataUrl(dataUrl, callback) {
        if (!dataUrl) {
          return
        }

        try {
          var tmpImg = new Image()
          tmpImg.onload = function () {
            canvas.style.display = "block"
            canvas.width = tmpImg.width
            canvas.height = tmpImg.height
            ctx.clearRect(0, 0, canvas.width, canvas.height)
            ctx.drawImage(tmpImg, 0, 0)
            inputWidth.value = canvas.width
            inputHeight.value = canvas.height
            ratio = canvas.width / canvas.height
            displayScaleX = canvas.clientWidth / canvas.width
            displayScaleY = canvas.clientHeight / canvas.height
            img.src = dataUrl
            if (typeof callback === "function") {
              callback()
            }
          }
          tmpImg.src = dataUrl
        } catch (err) {
          //
        }
      }

      function syncImageFromCanvas() {
        try {
          img.src = canvas.toDataURL()
        } catch (err) {
          //
        }
      }

      function clampColorComponent(value) {
        var parsed = parseInt(value, 10)
        if (!isFinite(parsed)) {
          return null
        }
        return clamp(parsed, 0, 255)
      }

      function normalizeHexColor(hex) {
        if (typeof hex !== "string") {
          return null
        }
        var value = hex.trim().replace(/^#/, "")
        if (value.length === 3) {
          value = value[0] + value[0] + value[1] + value[1] + value[2] + value[2]
        }
        if (value.length !== 6 || !/^[0-9a-f]{6}$/i.test(value)) {
          return null
        }
        return "#" + value.toLowerCase()
      }

      function hexToRgbArray(hex) {
        var normalized = normalizeHexColor(hex)
        if (!normalized) {
          return null
        }
        var intVal = parseInt(normalized.slice(1), 16)
        return [(intVal >> 16) & 255, (intVal >> 8) & 255, intVal & 255]
      }

      function rgbArrayToHex(rgbArray) {
        if (!Array.isArray(rgbArray) || rgbArray.length !== 3) {
          return null
        }
        var parts = []
        for (var i = 0; i < 3; i++) {
          var component = clampColorComponent(rgbArray[i])
          if (component === null) {
            return null
          }
          parts.push(component.toString(16).padStart(2, "0"))
        }
        return "#" + parts.join("")
      }

      function parseRgbInput(value) {
        if (typeof value !== "string") {
          return null
        }
        var parts = value.split(/[, ]+/).filter(Boolean)
        if (parts.length !== 3) {
          return null
        }
        var rgb = []
        for (var i = 0; i < 3; i++) {
          var component = clampColorComponent(parts[i])
          if (component === null) {
            return null
          }
          rgb.push(component)
        }
        return rgb
      }

      function updateColorUI(hexValue) {
        var normalized = normalizeHexColor(hexValue)
        if (!normalized) {
          return
        }

        shapeColor = normalized
        if (colorPreview) {
          colorPreview.style.backgroundColor = normalized
        }

        if (isUpdatingColorInputs) {
          return
        }

        var rgb = hexToRgbArray(normalized)
        isUpdatingColorInputs = true
        if (inputShapeColorHex) {
          inputShapeColorHex.value = normalized
        }
        if (inputShapeColorRgb && rgb) {
          inputShapeColorRgb.value = rgb.join(",")
        }
        isUpdatingColorInputs = false
      }

      function setColorPickerEnabled(enabled) {
        if (!colorPicker) {
          return
        }
        if (enabled) {
          colorPicker.classList.remove("disabled")
        } else {
          colorPicker.classList.add("disabled")
        }
        if (inputShapeColorHex) {
          inputShapeColorHex.disabled = !enabled
        }
        if (inputShapeColorRgb) {
          inputShapeColorRgb.disabled = !enabled
        }
      }

      function undo() {
        if (!canvas || !canvas.width || !canvas.height || undoStack.length === 0) {
          return
        }
        try {
          clearSelection()
          var currentState = canvas.toDataURL()
          var targetState = undoStack.pop()
          loadImageFromDataUrl(targetState, function () {
            redoStack.push(currentState)
            updateUndoRedoButtons()
          })
        } catch (err) {
          //
        }
      }

      function redo() {
        if (!canvas || !canvas.width || !canvas.height || redoStack.length === 0) {
          return
        }
        try {
          clearSelection()
          var currentState = canvas.toDataURL()
          var targetState = redoStack.pop()
          loadImageFromDataUrl(targetState, function () {
            undoStack.push(currentState)
            updateUndoRedoButtons()
          })
        } catch (err) {
          //
        }
      }

      function setActiveTool(toolName, options) {
        options = options || {}
        var preserveSelection = !!options.preserveSelection
        var requestedTool = toolName
        if (toolName && toolName === activeTool) {
          requestedTool = null
        }
        activeTool = requestedTool

        var entries = [
          { btn: btnDrawSquare, tool: "square" },
          { btn: btnDrawSquareOutline, tool: "squareOutline" },
          { btn: btnDrawCircle, tool: "circle" },
          { btn: btnDrawCircleOutline, tool: "circleOutline" },
          { btn: btnDrawLine, tool: "line" },
          { btn: btnCrop, tool: "crop" },
        ]

        for (var i = 0; i < entries.length; i++) {
          var entry = entries[i]
          if (!entry.btn) {
            continue
          }
          if (entry.tool === activeTool) {
            entry.btn.classList.add("selected")
          } else {
            entry.btn.classList.remove("selected")
          }
        }

        // reset interactive states
        isDrawingShape = false
        isCropping = false
        isResizing = false
        resizeHandle = null
        startX = null
        startY = null
        handles = []

        if (!preserveSelection) {
          currentSelection = null
          redrawBaseImage()
        } else if (currentSelection) {
          drawSelectionRect()
        } else {
          redrawBaseImage()
        }
      }

      function redrawBaseImage() {
        if (!ctx || !canvas) {
          return
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height)
        if (img && img.width && img.height) {
          ctx.drawImage(img, 0, 0)
        }
      }

      function getShapeDrawInfo(endX, endY) {
        if (!activeTool) {
          return null
        }

        var diffX = endX - startX
        var diffY = endY - startY

        switch (activeTool) {
          case "square":
          case "squareOutline": {
            var size = Math.min(Math.abs(diffX), Math.abs(diffY))
            if (size < 1) {
              return null
            }
            return {
              kind: activeTool === "square" ? "rectFill" : "rectStroke",
              x: diffX >= 0 ? startX : startX - size,
              y: diffY >= 0 ? startY : startY - size,
              size: size,
            }
          }
          case "circle":
          case "circleOutline": {
            var diameter = Math.min(Math.abs(diffX), Math.abs(diffY))
            if (diameter < 2) {
              return null
            }
            var originX = diffX >= 0 ? startX : startX - diameter
            var originY = diffY >= 0 ? startY : startY - diameter
            return {
              kind: activeTool === "circle" ? "circleFill" : "circleStroke",
              cx: originX + diameter / 2,
              cy: originY + diameter / 2,
              radius: diameter / 2,
            }
          }
          case "line": {
            var length = Math.hypot(diffX, diffY)
            if (length < 1) {
              return null
            }
            return {
              kind: "line",
              x1: startX,
              y1: startY,
              x2: endX,
              y2: endY,
            }
          }
        }
        return null
      }

      function drawActiveShape(endX, endY, checkOnly) {
        if (!ctx || !activeTool) {
          return false
        }
        if (typeof startX !== "number" || typeof startY !== "number") {
          return false
        }

        var info = getShapeDrawInfo(endX, endY)
        if (!info) {
          return false
        }

        if (checkOnly) {
          return true
        }

        var color = shapeColor || "#000000"

        ctx.save()
        switch (info.kind) {
          case "rectFill":
            ctx.fillStyle = color
            ctx.fillRect(info.x, info.y, info.size, info.size)
            break
          case "rectStroke":
            ctx.strokeStyle = color
            ctx.lineWidth = 3
            ctx.strokeRect(info.x, info.y, info.size, info.size)
            break
          case "circleFill":
            ctx.beginPath()
            ctx.fillStyle = color
            ctx.arc(info.cx, info.cy, info.radius, 0, Math.PI * 2)
            ctx.fill()
            ctx.closePath()
            break
          case "circleStroke":
            ctx.beginPath()
            ctx.strokeStyle = color
            ctx.lineWidth = 3
            ctx.arc(info.cx, info.cy, info.radius, 0, Math.PI * 2)
            ctx.stroke()
            ctx.closePath()
            break
          case "line":
            ctx.beginPath()
            ctx.strokeStyle = color
            ctx.lineWidth = 2
            ctx.lineCap = "round"
            ctx.moveTo(info.x1, info.y1)
            ctx.lineTo(info.x2, info.y2)
            ctx.stroke()
            break
        }
        ctx.restore()

        return true
      }

      function drawShapePreview(endX, endY) {
        redrawBaseImage()
        drawActiveShape(endX, endY)
      }

      function finalizeShape(endX, endY) {
        redrawBaseImage()
        var canDraw = drawActiveShape(endX, endY, true)
        if (canDraw) {
          captureUndoState()
          drawActiveShape(endX, endY)
          syncImageFromCanvas()
        } else {
          redrawBaseImage()
        }
      }

      function drawSelectionRect() {
        if (!currentSelection) {
          return
        }

        currentSelection = sanitizeSelection(currentSelection)

        ctx.clearRect(0, 0, canvas.width, canvas.height)
        ctx.drawImage(img, 0, 0)

        // darken outside selection using semi-transparent rectangles
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)"
        ctx.fillRect(0, 0, canvas.width, currentSelection.y)
        ctx.fillRect(
          0,
          currentSelection.y + currentSelection.height,
          canvas.width,
          canvas.height - (currentSelection.y + currentSelection.height)
        )
        ctx.fillRect(
          0,
          currentSelection.y,
          currentSelection.x,
          currentSelection.height
        )
        ctx.fillRect(
          currentSelection.x + currentSelection.width,
          currentSelection.y,
          canvas.width - (currentSelection.x + currentSelection.width),
          currentSelection.height
        )

        ctx.strokeStyle = "#FFF"
        ctx.lineWidth = 2
        ctx.strokeRect(
          currentSelection.x,
          currentSelection.y,
          currentSelection.width,
          currentSelection.height
        )
        ctx.fillStyle = "rgba(0,0,0,0)"
        ctx.fillRect(
          currentSelection.x,
          currentSelection.y,
          currentSelection.width,
          currentSelection.height
        )

        handles = [
          { x: currentSelection.x, y: currentSelection.y, c: "nw" },
          {
            x: currentSelection.x + currentSelection.width,
            y: currentSelection.y,
            c: "ne",
          },
          {
            x: currentSelection.x,
            y: currentSelection.y + currentSelection.height,
            c: "sw",
          },
          {
            x: currentSelection.x + currentSelection.width,
            y: currentSelection.y + currentSelection.height,
            c: "se",
          },
          {
            x: currentSelection.x + currentSelection.width / 2,
            y: currentSelection.y,
            c: "n",
          },
          {
            x: currentSelection.x + currentSelection.width / 2,
            y: currentSelection.y + currentSelection.height,
            c: "s",
          },
          {
            x: currentSelection.x,
            y: currentSelection.y + currentSelection.height / 2,
            c: "w",
          },
          {
            x: currentSelection.x + currentSelection.width,
            y: currentSelection.y + currentSelection.height / 2,
            c: "e",
          },
        ]

        ctx.fillStyle = "#FFF"

        for (var h of handles) {
          ctx.fillRect(
            h.x - HANDLE_SIZE / 2,
            h.y - HANDLE_SIZE / 2,
            HANDLE_SIZE,
            HANDLE_SIZE
          )
        }
      }

      function getHandleAt(x, y) {
        for (var h of handles) {
          if (
            x >= h.x - HANDLE_SIZE / 2 &&
            x <= h.x + HANDLE_SIZE / 2 &&
            y >= h.y - HANDLE_SIZE / 2 &&
            y <= h.y + HANDLE_SIZE / 2
          ) {
            return h.c
          }
        }
        return null
      }

      function smoothResizeCanvas(cv, scale) {
        if (!(scale < 1) || !(scale > 0)) {
          throw "scale must be a positive number <1 "
        }
        var sqScale = scale * scale
        var sw = cv.width
        var sh = cv.height
        var tw = Math.floor(sw * scale)
        var th = Math.floor(sh * scale)
        var sx = 0
        var sy = 0
        var sIndex = 0
        var tx = 0
        var ty = 0
        var yIndex = 0
        var tIndex = 0
        var tX = 0
        var tY = 0
        var w = 0
        var nw = 0
        var wx = 0
        var nwx = 0
        var wy = 0
        var nwy = 0
        var sR = 0
        var sG = 0
        var sB = 0
        var sA = 0
        var crossX = false
        var crossY = false
        var sBuffer = cv.getContext("2d").getImageData(0, 0, sw, sh).data
        var tBuffer = new Float32Array(4 * sw * sh)

        for (sy = 0; sy < sh; sy++) {
          ty = sy * scale
          tY = 0 | ty
          yIndex = 4 * tY * tw
          crossY = tY != (0 | (ty + scale))
          if (crossY) {
            wy = tY + 1 - ty
            nwy = ty + scale - tY - 1
          }
          for (sx = 0; sx < sw; sx++, sIndex += 4) {
            tx = sx * scale
            tX = 0 | tx
            tIndex = yIndex + tX * 4
            crossX = tX != (0 | (tx + scale))
            if (crossX) {
              wx = tX + 1 - tx
              nwx = tx + scale - tX - 1
            }
            sR = sBuffer[sIndex]
            sG = sBuffer[sIndex + 1]
            sB = sBuffer[sIndex + 2]
            sA = sBuffer[sIndex + 3]
            if (!crossX && !crossY) {
              tBuffer[tIndex] = tBuffer[tIndex] + sR * sqScale
              tBuffer[tIndex + 1] = tBuffer[tIndex + 1] + sG * sqScale
              tBuffer[tIndex + 2] = tBuffer[tIndex + 2] + sB * sqScale
              tBuffer[tIndex + 3] = tBuffer[tIndex + 3] + sA * sqScale
            } else if (crossX && !crossY) {
              w = wx * scale
              tBuffer[tIndex] = tBuffer[tIndex] + sR * w
              tBuffer[tIndex + 1] = tBuffer[tIndex + 1] + sG * w
              tBuffer[tIndex + 2] = tBuffer[tIndex + 2] + sB * w
              tBuffer[tIndex + 3] = tBuffer[tIndex + 3] + sA * w
              nw = nwx * scale
              tBuffer[tIndex + 4] = tBuffer[tIndex + 4] + sR * nw
              tBuffer[tIndex + 5] = tBuffer[tIndex + 5] + sG * nw
              tBuffer[tIndex + 6] = tBuffer[tIndex + 6] + sB * nw
              tBuffer[tIndex + 7] = tBuffer[tIndex + 7] + sA * nw
            } else if (crossY && !crossX) {
              w = wy * scale
              tBuffer[tIndex] = tBuffer[tIndex] + sR * w
              tBuffer[tIndex + 1] = tBuffer[tIndex + 1] + sG * w
              tBuffer[tIndex + 2] = tBuffer[tIndex + 2] + sB * w
              tBuffer[tIndex + 3] = tBuffer[tIndex + 3] + sA * w
              nw = nwy * scale
              tBuffer[tIndex + 4 * tw] = tBuffer[tIndex + 4 * tw] + sR * nw
              tBuffer[tIndex + 4 * tw + 1] = tBuffer[tIndex + 4 * tw + 1] + sG * nw
              tBuffer[tIndex + 4 * tw + 2] = tBuffer[tIndex + 4 * tw + 2] + sB * nw
              tBuffer[tIndex + 4 * tw + 3] = tBuffer[tIndex + 4 * tw + 3] + sA * nw
            } else {
              w = wx * wy
              tBuffer[tIndex] = tBuffer[tIndex] + sR * w
              tBuffer[tIndex + 1] = tBuffer[tIndex + 1] + sG * w
              tBuffer[tIndex + 2] = tBuffer[tIndex + 2] + sB * w
              tBuffer[tIndex + 3] = tBuffer[tIndex + 3] + sA * w

              nw = nwx * wy
              tBuffer[tIndex + 4] = tBuffer[tIndex + 4] + sR * nw
              tBuffer[tIndex + 5] = tBuffer[tIndex + 5] + sG * nw
              tBuffer[tIndex + 6] = tBuffer[tIndex + 6] + sB * nw
              tBuffer[tIndex + 7] = tBuffer[tIndex + 7] + sA * nw

              nw = wx * nwy
              tBuffer[tIndex + 4 * tw] = tBuffer[tIndex + 4 * tw] + sR * nw
              tBuffer[tIndex + 4 * tw + 1] = tBuffer[tIndex + 4 * tw + 1] + sG * nw
              tBuffer[tIndex + 4 * tw + 2] = tBuffer[tIndex + 4 * tw + 2] + sB * nw
              tBuffer[tIndex + 4 * tw + 3] = tBuffer[tIndex + 4 * tw + 3] + sA * nw

              nw = nwx * nwy
              tBuffer[tIndex + 4 * tw + 4] = tBuffer[tIndex + 4 * tw + 4] + sR * nw
              tBuffer[tIndex + 4 * tw + 5] = tBuffer[tIndex + 4 * tw + 5] + sG * nw
              tBuffer[tIndex + 4 * tw + 6] = tBuffer[tIndex + 4 * tw + 6] + sB * nw
              tBuffer[tIndex + 4 * tw + 7] = tBuffer[tIndex + 4 * tw + 7] + sA * nw
            }
          }
        }

        // create result canvas and convert float buffer to image data
        var resCV = document.createElement("canvas")
        resCV.width = tw
        resCV.height = th
        var resCtx = resCV.getContext("2d")
        var imgRes = resCtx.getImageData(0, 0, tw, th)
        var tByteBuffer = imgRes.data
        var pxIndex = 0
        for (var i = 0, n = tByteBuffer.length; i < n; i = i + 4) {
          tByteBuffer[i] = Math.ceil(tBuffer[pxIndex])
          tByteBuffer[i + 1] = Math.ceil(tBuffer[pxIndex + 1])
          tByteBuffer[i + 2] = Math.ceil(tBuffer[pxIndex + 2])
          tByteBuffer[i + 3] = Math.ceil(tBuffer[pxIndex + 3])
          pxIndex = pxIndex + 4
        }
        resCtx.putImageData(imgRes, 0, 0)
        return resCV
      }

      window.addEventListener("load", function () {
        if (window.top === window.self) {
          // hiding the spinner
          document.querySelector(".pleasewait").style.display = "none"
          document.getElementsByTagName("body")[0].style.backgroundColor = "#808080"

          // showing the image editor
          document.querySelector(".toolbar").style.display = "inline-block"

          // locating the elements
          btnOpen = document.getElementById("btnOpen")
          btnFlipH = document.getElementById("btnFlipH")
          btnFlipV = document.getElementById("btnFlipV")
          btnRotateRight = document.getElementById("btnRotateRight")
          btnRotateLeft = document.getElementById("btnRotateLeft")
          btnCrop = document.getElementById("btnCrop")
          btnMergeH = document.getElementById("btnMergeH")
          btnMergeV = document.getElementById("btnMergeV")
          btnResize = document.getElementById("btnResize")
          inputWidth = document.getElementById("inputWidth")
          inputHeight = document.getElementById("inputHeight")
          checkKeepRatio = document.getElementById("checkKeepRatio")
          labelKeepRatio = document.getElementById("labelKeepRatio")
          keepRatioLabel = document.getElementById("keepRatioLabel")
          labelBinary = document.getElementById("labelBinary")
          btnDownloadJPG = document.getElementById("btnDownloadJPG")
          btnDownloadPNG = document.getElementById("btnDownloadPNG")
          btnDownloadWEBP = document.getElementById("btnDownloadWEBP")
          labelBase64 = document.getElementById("labelBase64")
          btnDownloadJPGBase64 = document.getElementById("btnDownloadJPGBase64")
          btnDownloadPNGBase64 = document.getElementById("btnDownloadPNGBase64")
          btnDownloadWEBPBase64 = document.getElementById("btnDownloadWEBPBase64")
          fileSelector = document.getElementById("fileSelector")
          mergeFileSelector = document.getElementById("mergeFileSelector")
          btnUndo = document.getElementById("btnUndo")
          btnRedo = document.getElementById("btnRedo")
          btnDrawSquare = document.getElementById("btnDrawSquare")
          btnDrawSquareOutline = document.getElementById("btnDrawSquareOutline")
          btnDrawCircle = document.getElementById("btnDrawCircle")
          btnDrawCircleOutline = document.getElementById("btnDrawCircleOutline")
          btnDrawLine = document.getElementById("btnDrawLine")
          colorPicker = document.getElementById("colorPicker")
          colorPreview = document.getElementById("colorPreview")
          inputShapeColorHex = document.getElementById("inputShapeColorHex")
          inputShapeColorRgb = document.getElementById("inputShapeColorRgb")
          canvas = document.getElementById("canvas")
          ctx = canvas.getContext("2d")

          // adding texts to elements
          inputWidth.placeholder = t("width")
          inputHeight.placeholder = t("height")
          labelKeepRatio.innerText = t("keepRatio")
          labelBinary.innerText = t("binary")
          updateColorUI(shapeColor)

          disableAll()

          fileSelector.addEventListener("change", function (e) {
            var file = e.target.files[0]
            if (!file) {
              return
            }

            var nameWithoutExt = file.name.replace(/\.[^/.]+$/, "")

            var reader = new FileReader()
            reader.onload = function (evt) {
              var fileType = file.type.toLowerCase()

              if (fileType.toLowerCase().includes("svg")) {
                btnOpen.disabled = true
                btnOpen.classList.remove("disabled")
                btnOpen.classList.add("disabled")
                disableAll()
                inputCustom(
                  t("setSize"),
                  t("width"),
                  t("height"),
                  t("accept"),
                  t("cancel"),
                  function (width, height) {
                    originalFileName = nameWithoutExt

                    width = parseInt(width)
                    height = parseInt(height)

                    var svgText = evt.target.result

                    var blob = new Blob([svgText], { type: "image/svg+xml" })
                    var url = URL.createObjectURL(blob)

                    img = new Image()
                    img.onload = function () {
                      var w = width || 16
                      var h = height || 16
                      canvas.style.display = "block"
                      canvas.width = w
                      canvas.height = h
                      ctx.clearRect(0, 0, w, h)
                      ctx.drawImage(img, 0, 0, w, h)
                      inputWidth.value = w
                      inputHeight.value = h
                      ratio = w / h
                      displayScaleX = canvas.clientWidth / w
                      displayScaleY = canvas.clientHeight / h
                      syncImageFromCanvas()
                      URL.revokeObjectURL(url)
                      btnOpen.disabled = false
                      btnOpen.classList.remove("disabled")
                      enableAll()
                    }
                    img.src = url
                  },
                  function () {
                    btnOpen.disabled = false
                    btnOpen.classList.remove("disabled")
                    if (originalFileName) {
                      enableAll(true)
                    }
                  }
                )
              } else {
                img = new Image()
                img.onload = function () {
                  originalFileName = nameWithoutExt
                  canvas.style.display = "block"
                  canvas.width = img.width
                  canvas.height = img.height
                  ctx.drawImage(img, 0, 0)
                  inputWidth.value = img.width
                  inputHeight.value = img.height
                  ratio = img.width / img.height
                  displayScaleX = canvas.clientWidth / img.width
                  displayScaleY = canvas.clientHeight / img.height
                  enableAll()
                  img.onload = null
                }
                img.src = evt.target.result
              }
              fileSelector.value = null
            }

            if (file.type.toLowerCase().includes("svg")) {
              reader.readAsText(file)
            } else {
              reader.readAsDataURL(file)
            }
          })

          if (btnDrawSquare) {
            btnDrawSquare.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              setActiveTool("square")
            })
          }

          if (btnDrawSquareOutline) {
            btnDrawSquareOutline.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              setActiveTool("squareOutline")
            })
          }

          if (btnDrawCircle) {
            btnDrawCircle.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              setActiveTool("circle")
            })
          }

          if (btnDrawCircleOutline) {
            btnDrawCircleOutline.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              setActiveTool("circleOutline")
            })
          }

          if (btnDrawLine) {
            btnDrawLine.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              setActiveTool("line")
            })
          }

          if (inputShapeColorHex) {
            inputShapeColorHex.addEventListener("input", function (e) {
              if (!originalFileName || isUpdatingColorInputs) {
                return
              }
              var normalized = normalizeHexColor(e.target.value || "")
              if (normalized) {
                updateColorUI(normalized)
              }
            })
            inputShapeColorHex.addEventListener("blur", function () {
              if (!inputShapeColorHex) {
                return
              }
              if (!normalizeHexColor(inputShapeColorHex.value || "")) {
                isUpdatingColorInputs = true
                inputShapeColorHex.value = shapeColor
                isUpdatingColorInputs = false
              }
            })
          }

          if (inputShapeColorRgb) {
            inputShapeColorRgb.addEventListener("input", function (e) {
              if (!originalFileName || isUpdatingColorInputs) {
                return
              }
              var rgb = parseRgbInput(e.target.value || "")
              if (rgb) {
                var hex = rgbArrayToHex(rgb)
                if (hex) {
                  updateColorUI(hex)
                }
              }
            })
            inputShapeColorRgb.addEventListener("blur", function () {
              if (!inputShapeColorRgb) {
                return
              }
              var rgb = parseRgbInput(inputShapeColorRgb.value || "")
              if (!rgb) {
                isUpdatingColorInputs = true
                var currentRgb = hexToRgbArray(shapeColor)
                if (currentRgb) {
                  inputShapeColorRgb.value = currentRgb.join(",")
                }
                isUpdatingColorInputs = false
              }
            })
          }

          if (colorPreview && inputShapeColorHex) {
            colorPreview.addEventListener("click", function () {
              if (
                colorPicker &&
                colorPicker.classList &&
                colorPicker.classList.contains("disabled")
              ) {
                return
              }
              inputShapeColorHex.focus()
            })
          }

          if (btnUndo) {
            btnUndo.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              undo()
            })
          }

          if (btnRedo) {
            btnRedo.addEventListener("click", function () {
              if (!originalFileName) {
                return
              }
              redo()
            })
          }

          btnDownloadJPG.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            downloadImage("jpeg", false)
          })

          btnDownloadPNG.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            downloadImage("png", false)
          })

          btnDownloadWEBP.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            downloadImage("webp", false)
          })

          btnDownloadJPGBase64.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            downloadImage("jpeg", true)
          })

          btnDownloadPNGBase64.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            downloadImage("png", true)
          })

          btnDownloadWEBPBase64.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            downloadImage("webp", true)
          })

          btnRotateLeft.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            rotate(-90)
          })

          btnRotateRight.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            rotate(90)
          })

          btnCrop.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            if (activeTool) {
              setActiveTool(null, { preserveSelection: true })
            }

            if (!currentSelection) {
              return
            }

            redrawBaseImage()
            captureUndoState()

            // create a new canvas for the cropped area
            var croppedCanvas = document.createElement("canvas")
            croppedCanvas.width = currentSelection.width
            croppedCanvas.height = currentSelection.height
            var croppedCtx = croppedCanvas.getContext("2d")

            // draw from the original image (not from current canvas)
            croppedCtx.drawImage(
              img,
              currentSelection.x,
              currentSelection.y,
              currentSelection.width,
              currentSelection.height,
              0,
              0,
              currentSelection.width,
              currentSelection.height
            )

            // replace the main canvas content
            canvas.width = currentSelection.width
            canvas.height = currentSelection.height
            ctx.drawImage(croppedCanvas, 0, 0)

            // update the image source to the new cropped image
            syncImageFromCanvas()

            // clear the selection and ensure no red rectangle remains
            currentSelection = null
            inputWidth.value = canvas.width
            inputHeight.value = canvas.height
            ratio = canvas.width / canvas.height
            displayScaleX = canvas.clientWidth / canvas.width
            displayScaleY = canvas.clientHeight / canvas.height
          })

          btnResize.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            var newW = parseInt(inputWidth.value)
            var newH = parseInt(inputHeight.value)
            if (checkKeepRatio.checked) {
              if (newW && !newH) {
                newH = Math.round(newW / ratio)
              }
              if (newH && !newW) {
                newW = Math.round(newH * ratio)
              }
            }

            if (!newW || !newH) {
              return
            }

            captureUndoState()

            var currentW = canvas.width
            var currentH = canvas.height
            var scaleW = newW / currentW
            var scaleH = newH / currentH
            var scale = Math.min(scaleW, scaleH)
            var scaledCanvas
            if (scale < 1) {
              scaledCanvas = smoothResizeCanvas(canvas, scale)
            } else {
              scaledCanvas = document.createElement("canvas")
              scaledCanvas.width = Math.round(currentW * scale)
              scaledCanvas.height = Math.round(currentH * scale)
              var scaledCtx = scaledCanvas.getContext("2d")
              scaledCtx.imageSmoothingEnabled = true
              scaledCtx.imageSmoothingQuality = "high"
              scaledCtx.drawImage(
                canvas,
                0,
                0,
                currentW,
                currentH,
                0,
                0,
                scaledCanvas.width,
                scaledCanvas.height
              )
            }
            canvas.width = scaledCanvas.width
            canvas.height = scaledCanvas.height
            ctx.drawImage(scaledCanvas, 0, 0)
            syncImageFromCanvas()
            ratio = canvas.width / canvas.height
            inputWidth.value = canvas.width
            inputHeight.value = canvas.height
            displayScaleX = canvas.clientWidth / canvas.width
            displayScaleY = canvas.clientHeight / canvas.height
          })

          btnFlipH.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            flip(true, false)
          })

          btnFlipV.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            flip(false, true)
          })

          btnMergeH.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            mustMergeHorizontal = true
            mergeFileSelector.click()
          })

          btnMergeV.addEventListener("click", function () {
            if (!originalFileName) {
              return
            }

            clearSelection()
            mustMergeHorizontal = false
            mergeFileSelector.click()
          })

          inputWidth.addEventListener("input", function () {
            if (!originalFileName) {
              return
            }

            if (updating || !checkKeepRatio.checked) {
              return
            }

            updating = true
            var newW = parseInt(inputWidth.value)
            if (newW > 0) {
              inputHeight.value = Math.round(newW / ratio)
            }
            updating = false
          })

          inputHeight.addEventListener("input", function () {
            if (!originalFileName) {
              return
            }

            if (updating || !checkKeepRatio.checked) {
              return
            }

            updating = true
            var newH = parseInt(inputHeight.value)
            if (newH > 0) {
              inputWidth.value = Math.round(newH * ratio)
            }
            updating = false
          })

          mergeFileSelector.addEventListener("change", function (e) {
            if (!originalFileName) {
              return
            }

            var file = e.target.files[0]
            if (!file) {
              return
            }

            var reader = new FileReader()
            reader.onload = function (evt) {
              var fileType = file.type.toLowerCase()

              if (fileType.toLowerCase().includes("svg")) {
                var svgText = evt.target.result

                var blob = new Blob([svgText], { type: "image/svg+xml" })
                var url = URL.createObjectURL(blob)

                var svgImg = new Image()
                svgImg.onload = function () {
                  var tmpCanvas = document.createElement("canvas")

                  var svgW = svgImg.naturalWidth || svgImg.width || 2000
                  var svgH = svgImg.naturalHeight || svgImg.height || 2000

                  var svgScale
                  if (mustMergeHorizontal) {
                    svgScale = img.height / svgH
                  } else {
                    svgScale = img.width / svgW
                  }

                  var w = svgW * svgScale
                  var h = svgH * svgScale

                  tmpCanvas.width = w
                  tmpCanvas.height = h
                  var tctx = tmpCanvas.getContext("2d")
                  tctx.drawImage(svgImg, 0, 0, w, h)

                  mergeImg = new Image()
                  mergeImg.src = tmpCanvas.toDataURL()
                  mergeImg.onload = function () {
                    mergeImages(mustMergeHorizontal)
                  }
                  URL.revokeObjectURL(url)
                }
                svgImg.src = url
              } else {
                mergeImg = new Image()
                mergeImg.src = evt.target.result
                mergeImg.onload = function () {
                  mergeImages(mustMergeHorizontal)
                }
              }
            }

            if (file.type.toLowerCase().includes("svg")) {
              reader.readAsText(file)
            } else {
              reader.readAsDataURL(file)
            }
          })

          canvas.addEventListener("mousedown", function (e) {
            if (!originalFileName) {
              return
            }

            if (!img.src) {
              return
            }

            if (e.button !== 0) {
              return
            }

            if (canvas.width === 0 || canvas.height === 0) {
              return
            }

            displayScaleX = canvas.clientWidth / canvas.width
            displayScaleY = canvas.clientHeight / canvas.height

            var rect = canvas.getBoundingClientRect()
            var x = (e.clientX - rect.left) / displayScaleX
            var y = (e.clientY - rect.top) / displayScaleY

            x = clamp(x, 0, canvas.width)
            y = clamp(y, 0, canvas.height)

            if (activeTool) {
              isDrawingShape = true
              startX = x
              startY = y
              currentSelection = null
              redrawBaseImage()
              return
            }

            if (currentSelection) {
              var handle = getHandleAt(x, y)
              if (handle) {
                isResizing = true
                resizeHandle = handle
                return
              }

              if (
                x < currentSelection.x ||
                x > currentSelection.x + currentSelection.width ||
                y < currentSelection.y ||
                y > currentSelection.y + currentSelection.height
              ) {
                currentSelection = null
                ctx.drawImage(img, 0, 0)
                return
              }
            }

            isCropping = true

            if (!startX) {
              startX = x
              startY = y
            }
          })

          document.addEventListener("mousemove", function (e) {
            if (!originalFileName) {
              return
            }

            if (!isCropping && !isResizing && !isDrawingShape) {
              return
            }

            if (!canvas || canvas.width === 0 || canvas.height === 0) {
              return
            }

            var rect = canvas.getBoundingClientRect()
            var x = (e.clientX - rect.left) / displayScaleX
            var y = (e.clientY - rect.top) / displayScaleY

            x = clamp(x, 0, canvas.width)
            y = clamp(y, 0, canvas.height)

            if (isDrawingShape && activeTool) {
              drawShapePreview(x, y)
              return
            }

            if (isCropping) {
              currentSelection = {
                x: startX,
                y: startY,
                width: x - startX,
                height: y - startY,
              }
              drawSelectionRect()
            } else if (isResizing && currentSelection) {
              var prev = { ...currentSelection } // safe copy before changes

              switch (resizeHandle) {
                case "nw":
                  {
                    var newW = prev.width + (prev.x - x)
                    if (newW >= 1) {
                      currentSelection.x = x
                      currentSelection.width = newW
                    } else {
                      currentSelection.width = 1
                      currentSelection.x = prev.x + (prev.width - 1)
                    }

                    var newH = prev.height + (prev.y - y)
                    if (newH >= 1) {
                      currentSelection.y = y
                      currentSelection.height = newH
                    } else {
                      currentSelection.height = 1
                      currentSelection.y = prev.y + (prev.height - 1)
                    }
                  }
                  break

                case "ne":
                  {
                    var newW = x - prev.x
                    currentSelection.width = Math.max(1, newW)
                    var newH = prev.height + (prev.y - y)
                    if (newH >= 1) {
                      currentSelection.y = y
                      currentSelection.height = newH
                    } else {
                      currentSelection.height = 1
                      currentSelection.y = prev.y + (prev.height - 1)
                    }
                  }
                  break

                case "sw":
                  {
                    var newW = prev.width + (prev.x - x)
                    if (newW >= 1) {
                      currentSelection.x = x
                      currentSelection.width = newW
                    } else {
                      currentSelection.width = 1
                      currentSelection.x = prev.x + (prev.width - 1)
                    }
                    currentSelection.height = Math.max(1, y - prev.y)
                  }
                  break

                case "se":
                  currentSelection.width = Math.max(1, x - prev.x)
                  currentSelection.height = Math.max(1, y - prev.y)
                  break

                case "n":
                  {
                    var newH = prev.height + (prev.y - y)
                    if (newH >= 1) {
                      currentSelection.y = y
                      currentSelection.height = newH
                    } else {
                      currentSelection.height = 1
                      currentSelection.y = prev.y + (prev.height - 1)
                    }
                  }
                  break

                case "s":
                  currentSelection.height = Math.max(1, y - prev.y)
                  break

                case "w":
                  {
                    var newW = prev.width + (prev.x - x)
                    if (newW >= 1) {
                      currentSelection.x = x
                      currentSelection.width = newW
                    } else {
                      currentSelection.width = 1
                      currentSelection.x = prev.x + (prev.width - 1)
                    }
                  }
                  break

                case "e":
                  currentSelection.width = Math.max(1, x - prev.x)
                  break
              }
              drawSelectionRect()
            }
          })

          document.addEventListener("mouseup", function (e) {
            if (!originalFileName) {
              return
            }

            if (isDrawingShape && activeTool) {
              if (canvas && canvas.width !== 0 && canvas.height !== 0) {
                var rect = canvas.getBoundingClientRect()
                var x = (e.clientX - rect.left) / displayScaleX
                var y = (e.clientY - rect.top) / displayScaleY
                x = clamp(x, 0, canvas.width)
                y = clamp(y, 0, canvas.height)
                finalizeShape(x, y)
              }
              isDrawingShape = false
              startX = null
              startY = null
              return
            }

            if (isCropping) {
              isCropping = false
            } else if (isResizing) {
              isResizing = false
              resizeHandle = null
            }

            startX = null
            startY = null

            drawSelectionRect()
          })

          btnOpen.addEventListener("click", function () {
            fileSelector.click()
          })
        }
      })
    </script>
  </body>
</html>
